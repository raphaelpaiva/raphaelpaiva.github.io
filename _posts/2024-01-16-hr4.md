---
layout: post
title: "Como fazer um hotspot no Raspberry Pi | O Gravador sem Cabe√ßa #4"
date: 2024-01-05
tags: linux hotspot raspberrypi pt_BR
---

![header](/files/hr4/header.jpg)

Vamos continuar o nosso gravador sem cabe√ßa da [postagem anterior]({% post_url 2024-01-06-hr3 %}). Esse post n√£o requer a leitura dos anteriores, mas vou dar um pouco de contexto.

## Contexto

Eu quero criar um gravador em que voc√™ conecte interfaces de √°udio USB e ele as grave, controlando por um tablet.

Pra isso eu preciso saber se com um Raspberry Pi 3B sem tela, eu:
1. ~~Consigo gravar de uma interface de √°udio usando arecord?~~ ‚úÖ
2. ~~Consigo gravar de duas interfaces de √°udio simultaneamente usando arecord?~~ ‚úÖ
3. ~~Consigo usar um servi√ßo web pra disparar a grava√ß√£o?~~ ‚úÖ
4. Consigo conectar e enviar os comandos acima diretamente no pi como um hotspot?

Hoje vamos atacar o item #4: **Consigo conectar e enviar os comandos acima diretamente no pi como um hotspot?**

Bora l√°!

## M√£o na massa

N√≥s vamos mexer com a rede Wi-Fi do Raspberry Pi, ent√£o se voc√™ est√° conectado nele por Wi-Fi, use a rede cabeada, ou use-o diretamente com teclado e monitor para poder resolver qualquer problema que venha a ocorrer com o Wi-Fi.

Isso dito, vamos nos certificar que o Pi est√° usando o NetworkManager, que vai facilitar muito a nossa vida:

## Ativando o NetworkManager

```bash
raphaelpaiva@hr:~ $ sudo raspi-config
```

Isso deve abrir uma tela com um menu, parecida com esta aqui:

![menu](/files/hr4/menu.png)

Selecione a op√ß√£o `6 Advanced Options` e depois `AA Network Config`

![networkconfig](/files/hr4/netconf.png)

Depois disso, certifique-se de que a op√ß√£o `2 NetworkManager` est√° habilitada.

![nm](/files/hr4/nm.png)

Pronto! Se voc√™ perdeu a conex√£o, tente conectar novamente.

## Configurando o HotSpot

Pra configurar rede usando o NetworkManager, temos algumas op√ß√µes muito boas como o `nmcli` (via linha de comando) e o `nmtui` (interface semelhante ao `raspi-config`). Vamos de `nmcli` por ser mais direto.

Pra configurar o hotspot, temos uns comandos pra rodar. Basicamente `nmcli con add` pra adicionar uma conex√£o e `sudo nmcli con modify` pra modificar configura√ß√µes de uma conex√£o.

Vou explicar passo a passo.

```bash
# Cria uma conex√£o Wi-Fi chamada hr-hotspot com o mesmo ssid
raphaelpaiva@hr:~ $ sudo nmcli con add type Wi-Fi ifname wlan0 con-name hr-hotspot autoconnect yes ssid hr-hotspot

# Essa conex√£o vai estar no modo ap (access point) usando o banda bg e vai compartilhar qualquer outra conex√£o existente
# o compartilhamento n√£o √© necess√°rio, mas √© conveniente
raphaelpaiva@hr:~ $ sudo nmcli con modify hr-hotspot 802-11-wireless.mode ap 802-11-wireless.band bg ipv4.method shared

# Essa conex√£o vai usar seguran√ßa wpa-psk (passkey). N√£o √© o mais seguro, mas esse projeto n√£o requer muita seguran√ßa.
raphaelpaiva@hr:~ $ sudo nmcli con modify hr-hotspot Wi-Fi-sec.key-mgmt wpa-psk

# Vamos colocar uma senha bem segura...
raphaelpaiva@hr:~ $ sudo nmcli con modify hr-hotspot Wi-Fi-sec.psk "12345678"

# E vamos, finalmente, habilitar essa conex√£o.
raphaelpaiva@hr:~ $ sudo nmcli con up hr-hotspot
```

Vou rodar o servicinho que criamos na [postagem anterior]({% post_url 2024-01-06-hr3 %}) e tentar acess√°-lo.

```bash
raphaelpaiva@hr:~ $ cd hr
raphaelpaiva@hr:~/hr $ python -m uvicorn main:app --reload --host 0.0.0.0
INFO:     Will watch for changes in these directories: ['/home/raphaelpaiva/hr']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [1589] using WatchFiles
INFO:     Started server process [1592]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

Importante tamb√©m dar uma olhada no ip do pi nessa rede:

```bash
raphaelpaiva@hr:~ $ ip a
[...]
3: wlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether b8:27:eb:67:e6:84 brd ff:ff:ff:ff:ff:ff
    inet 10.42.0.1/24 brd 10.42.0.255 scope global noprefixroute wlan0
       valid_lft forever preferred_lft forever
    inet6 fe80::26aa:e855:d327:9941/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
```
Beleza! _10.42.0.1_.

Nesse ponto eu desconectei o cabo de rede pra me certificar de que n√£o havia nenhuma outra rede dispon√≠vel.

Vamos l√° pro meu tablet v√©io de guerra.
![conectando](/files/hr4/conect.jpg)

Colocando a senha mega segura...

![conectado](/files/hr4/conectado.jpg)

Vamos tentar agora acessar o servi√ßo. Lembrando que ele roda na porta `8000`, ent√£o vamos acessar `http://10.42.0.1:8000` e cruzar os dedos.

![sucesso](/files/hr4/sucesso.jpg)

Solta os fogos! üéâ

Dando uma olhada nos logs da aplica√ß√£o, d√° pra ver que o acesso veio da mesma rede do Pi:

```log
INFO:     10.42.0.177:37478 - "GET / HTTP/1.1" 200 OK
INFO:     10.42.0.177:37478 - "GET /favicon.ico HTTP/1.1" 404 Not Found
INFO:     10.42.0.177:41574 - "GET / HTTP/1.1" 200 OK
```

## Conclus√£o

Conseguimos acessar o Raspberry Pi diretamente via Wi-Fi e entrar no nosso servi√ßo, ou seja, todas as etapas pra validar a ideia do Gravador foram validadas!

Agora √© hora de pensar nele como um produto e estruturar um pouco mais ele como um todo. Vamos dar prosseguimento no pr√≥ximo post!

## Refer√™ncias

Claro que eu colei a configura√ß√£o de algum lugar, ent√£o segue o link da alma caridosa que compilou pra gente: [https://gist.github.com/narate/d3f001c97e1c981a59f94cd76f041140](https://gist.github.com/narate/d3f001c97e1c981a59f94cd76f041140). Obrigado, estranho!